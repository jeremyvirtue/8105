C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN .\Objects\System.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE User\System.c OMF2 ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE INCDIR(.\User;.
                    -\User\Drive) DEBUG PRINT(.\Listings\System.lst) OBJECT(.\Objects\System.obj)

line level    source

   1          #include "System.h"  
   2          #include "Lcd.h"
   3          #include "LcdDis.h"
   4          #include "kt_0646m.h"
   5          #include "UHF.h"
   6          #include "Flash.h"
   7          #include "KeyBoard.h"
   8          #include "RCC.h"
   9          #include "ADC.h"
  10           
  11           
  12          S_DATA xdata Sdata;
  13           
  14           
  15          void SysInit(void)
  16          {
  17   1              POWER = 0;//初始化POWER = 0
  18   1              Sdata.state = S_INIT;
  19   1              Sdata.start_flag = 0;
  20   1      }
  21          
  22          
  23           extern u8 tw_time;//递减闪烁
  24          void KeyMenu(void)
  25          {
  26   1              if(keys.mute_flag)
  27   1              {
  28   2                      keys.mute_flag = 0;
  29   2                      keys.mute = 2;
  30   2                      KT_WirelessMicTx_MuteSel(AUDIO_MUTE);
  31   2              }
  32   1      /*************************      key_1   ******************************/
  33   1              switch(keys.key_num)
  34   1              {
  35   2                      case K1_P:  
  36   2                              keys.key_num = 0; 
  37   2                              break;
  38   2                      case K1_R: 
  39   2                              keys.key_num = 0;       
  40   2                              if((Sdata.state == READY ||Sdata.state == START || Sdata.state == SET_AUTOMUTE)  && Sdata.start_flag ==
             - 0)///确认开机标志位
  41   2                              {
  42   3                                      Sdata.start_flag = 1;
  43   3                              }       
  44   2                              else if(Sdata.state == SHUTDOWN )//|| Sdata.state == S_INIT)
  45   2                              {  
  46   3                                      Sdata.stop_time = 12;
  47   3                              }
  48   2                              
  49   2                              if(Sdata.state == READY )
  50   2                              {
  51   3                                      Sdata.check = 0;
  52   3                                      SysState(CHECK_DIS);
  53   3                              }
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 2   

  54   2                              else if(Sdata.state == CHECK_DIS)
  55   2                              {
  56   3                                      SysState(CHECK_DIS);
  57   3                              }
  58   2                              
  59   2                              break;
  60   2                      case K1_C0_3S:  
  61   2                              if(Sdata.state == S_INIT || Sdata.state ==BAT_CHARGE)//开机
  62   2                              {
  63   3                                      SysState(START);
  64   3                              }       
  65   2                              break; 
  66   2                      case K1_C1S:
  67   2                              if(Sdata.state == READY && Sdata.start_flag )
  68   2                              {
  69   3                                      Sdata.start_flag = 0;//关机标志位
  70   3                                      Sdata.stop_time = 12;
  71   3                                      SysState(SHUTDOWN);
  72   3                              } 
  73   2                      break;
  74   2                      case K1_C10S:
  75   2                              if(Sdata.state == S_INIT )//继续长按调节自动静音
  76   2                              { 
  77   3                                      SysState(SET_AUTOMUTE);
  78   3                              }
  79   2                      break;
  80   2      /*******************************************************/
  81   2                              
  82   2      /*************************      key_2   ******************************/
  83   2                      case K2_P:  
  84   2                              if(Sdata.state == UHF_SET)//进入CH模式
  85   2                              {       
  86   3                                      tw_time = 4;
  87   3                                      SysState(UHF_CH);
  88   3                              }
  89   2                              else if(Sdata.state == UHF_CH)
  90   2                              {       
  91   3                                      tw_time = 4;
  92   3                                      ChAdd();
  93   3                                      SysState(UHF_CH);
  94   3                              }
  95   2                              else if(Sdata.state == SET_VOL)
  96   2                              {
  97   3                                      VolAdd();
  98   3                                      SysState(SET_VOL);
  99   3                              }
 100   2                              keys.key_num = 0; 
 101   2                              break;
 102   2                      case K2_R: 
 103   2                              keys.key_num = 0; 
 104   2                              if(Sdata.state == UHF_SET|| Sdata.state == UHF_CH )//快速调节初始化
 105   2                              {
 106   3                                      u_dat.quickpress = 0;
 107   3                              } 
 108   2                              else if(Sdata.state == READY && Sdata.start_flag == 1)//进入调节音量模式
 109   2                              {
 110   3                                      ShowIco(LCD_ICON_DB,SET);
 111   3                                      SysState(SET_VOL);
 112   3                              }
 113   2                              break;
 114   2                      case K2_C0_5S:  
 115   2                              keys.key_num = 0; 
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 3   

 116   2                              if(Sdata.state == READY)//开机长按进入调台
 117   2                              {
 118   3                                      tw_time = 4;
 119   3                                      SysState(UHF_SET); 
 120   3                              }  
 121   2                              if(Sdata.state == UHF_CH)//确认进入快速调节
 122   2                              {
 123   3                                      keyContinedClean();
 124   3                                      u_dat.quickpress = 1;
 125   3                              }
 126   2                              break; 
 127   2                      case K2_C80MS:  
 128   2                              keys.key_num = 0;  
 129   2                              if(Sdata.state == UHF_CH && u_dat.quickpress)//快速调节
 130   2                              {
 131   3                                      tw_time = 4;
 132   3                                      keyContinedClean();
 133   3                                      ChAdd();
 134   3                                      SysState(UHF_CH);       
 135   3                              }
 136   2                      break;
 137   2      /*******************************************************/
 138   2      
 139   2      /**********************         key3    *********************************/
 140   2                      case K3_P:  
 141   2                              if(Sdata.state == UHF_SET)//进入CH模式
 142   2                              {       
 143   3                                      tw_time = 4;
 144   3                                      SysState(UHF_CH);
 145   3                              }
 146   2                              else if(Sdata.state == UHF_CH)
 147   2                              {       
 148   3                                      tw_time = 4;
 149   3                                      ChLess();
 150   3                                      SysState(UHF_CH);
 151   3                              }
 152   2                              else if(Sdata.state == SET_VOL)
 153   2                              {
 154   3                                      VolLess();
 155   3                                      SysState(SET_VOL);
 156   3                              }
 157   2                              keys.key_num = 0; 
 158   2                              break;
 159   2                      case K3_R: 
 160   2                              keys.key_num = 0; 
 161   2                              if(Sdata.state == UHF_SET|| Sdata.state == UHF_CH )//快速调节初始化
 162   2                              {
 163   3                                      u_dat.quickpress = 0;
 164   3                              } 
 165   2                              else if(Sdata.state == READY  )//进入调节音量模式
 166   2                              {
 167   3                                      ShowIco(LCD_ICON_DB,SET);
 168   3                                      SysState(SET_VOL);
 169   3                              }
 170   2                              break;
 171   2                              break;
 172   2                      case K3_C0_5S: 
 173   2                              keys.key_num = 0; 
 174   2                              if(Sdata.state == READY)//开机长按进入调台
 175   2                              {
 176   3                                      tw_time = 4;
 177   3                                      SysState(UHF_SET); 
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 4   

 178   3                              }
 179   2                              if(Sdata.state == UHF_CH)//确认进入快速调节
 180   2                              {
 181   3                                      keyContinedClean();
 182   3                                      u_dat.quickpress = 1;
 183   3                              }
 184   2                              break; 
 185   2                      case K3_C80MS:  
 186   2                              keys.key_num = 0;  
 187   2                              if(Sdata.state == UHF_CH && u_dat.quickpress)//快速调节
 188   2                              {
 189   3                                      tw_time = 4;
 190   3                                      keyContinedClean();
 191   3                                      ChLess();
 192   3                                      SysState(UHF_CH);       
 193   3                              }
 194   2                      break;
 195   2      /*******************************************************/
 196   2                              
 197   2      /************************key_4*******************************/
 198   2                      case K4_P:  
 199   2                              keys.key_num = 0; 
 200   2      //                      if(Sdata.state == SET_EQ)
 201   2      //                      {
 202   2      //                              EqAdd();
 203   2      //                              SysState(SET_EQ);
 204   2      //                      } 
 205   2                              break;
 206   2                      case K4_R: 
 207   2                              keys.key_num = 0; 
 208   2      //                      if(Sdata.state == READY && Sdata.start_flag == 1)//进入调节音量模式
 209   2      //                      { 
 210   2      //                              SysState(SET_EQ);
 211   2      //                      }
 212   2                              break;
 213   2                      case K4_C0_5S: 
 214   2                              if(Sdata.state == READY)
 215   2                          {
 216   3                                      SysState(SET_ID);
 217   3                              }
 218   2                              keys.key_num = 0; 
 219   2                              break; 
 220   2      /*******************************************************/
 221   2                      
 222   2      /**********************twins*********************************/
 223   2                      case K1_K2_TWINS:
 224   2      //                      if(Sdata.state == READY)
 225   2      //                  {
 226   2      //                              SysState(SET_ID);
 227   2      //                      }
 228   2                              keys.key_num = 0; 
 229   2                      break;
 230   2      /*******************************************************/               
 231   2              }
 232   1      }
 233           
 234          
 235           
 236          void SysState(S_STATE state)
 237          {
 238   1              Sdata.state = state;
 239   1              switch(state)
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 5   

 240   1              {
 241   2                      case S_INIT:  
 242   2                               
 243   2                              break;  
 244   2                      case START: 
 245   2                      break;
 246   2                      case READY:  
 247   2                              BPSKMode(order1);
 248   2                              MuteLconDis();          
 249   2                              LockLconDis();
 250   2                              ChannelDis();
 251   2                      break;
 252   2                      case SHUTDOWN: 
 253   2                              KT_WirelessMicTx_MuteSel(AUDIO_MUTE); 
 254   2                              KT_WirelessMicTx_Pilot(PILOT_DISABLE);
 255   2                              LcdClean(); 
 256   2                              OffDis();
 257   2                              SetSysDelay(200);
 258   2                      break;
 259   2                      case UHF_SET:
 260   2                              SetPubFreq();
 261   2                              BPSKMode(order2);       
 262   2                              SetDis();
 263   2                              SetSysDelay(1000);
 264   2                      break;
 265   2                      case UHF_CH:
 266   2                              ChannelDis();
 267   2                              BPSKMode(order2);       
 268   2                              SetSysDelay(1000); 
 269   2                      break;
 270   2                      case SET_OK:  
 271   2                              KT_WirelessMicTx_PAGain(PA_Pos18dBm);
 272   2                              FreqTune(SetFreq());
 273   2                              SaveData();
 274   2                              OkDis(); 
 275   2                              SetSysDelay(120);
 276   2                      break;
 277   2                      case SET_ID: 
 278   2                              KT_WirelessMicTx_PASW(PA_ON);
 279   2                              KT_WirelessMicTx_PAGain(PA_Neg7dBm);
 280   2                              if(u_dat.id)
 281   2                                      u_dat.id = 0;
 282   2                              else
 283   2                                      u_dat.id = u_dat.ramid; 
 284   2                              LockLconDis();
 285   2                              IdDis();
 286   2                              SetPubFreq(); 
 287   2                              BPSKMode(order3);
 288   2                              SetSysDelay(800);
 289   2                      break;
 290   2                      case RAIL_DIS:  
 291   2                      break;
 292   2                      case SET_ID_PRESS: 
 293   2                              IdDis();
 294   2                      break;
 295   2                      case SET_VOL: 
 296   2                              VolDis();
 297   2                              BPSKMode(order1);       
 298   2                              SetSysDelay(400);
 299   2                      break;
 300   2                      case SET_AUTOMUTE:
 301   2                      {  
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 6   

 302   3                              Sdata.stop_time = 5;    
 303   3                              KT_WirelessMicTx_MuteSel(AUDIO_UNMUTE);
 304   3                              KT_WirelessMicTx_PASW(PA_ON);
 305   3                              if(u_dat.automute)
 306   3                                      u_dat.automute = 0;
 307   3                              else
 308   3                                      u_dat.automute = 1; 
 309   3                              MuteLconDis();
 310   3                              AutoMuteSwDis(); 
 311   3                              SetSysDelay(400);
 312   3                      }break;
 313   2                      case SET_EQ:
 314   2                              EqDis();
 315   2                              SetEqApi(u_dat.eq);
 316   2                              SetSysDelay(400);
 317   2                      break;
 318   2                      case BAT_CHARGE:
 319   2               
 320   2                      break;
 321   2                      case CHECK_DIS:
 322   2                              CheckDis();
 323   2                              SetSysDelay(200);
 324   2                      break;
 325   2              } 
 326   1      }
 327          
 328          void SetSysDelay(u16 time)
 329          {
 330   1              Sdata.s_delay = time;
 331   1      }
 332          
 333          void SysStaDelay(void)
 334          { 
 335   1              if(Sdata.s_delay > 0)
 336   1                      Sdata.s_flag = 1;
 337   1              if(Sdata.s_flag && Sdata.s_delay == 0)
 338   1              {
 339   2                      Sdata.s_flag = 0;
 340   2                      switch(Sdata.state)
 341   2                      {
 342   3                              case S_INIT:   
 343   3       
 344   3                                      break; 
 345   3                              case START:  
 346   3                              break;          
 347   3                              case READY:
 348   3                                      
 349   3                              break;  
 350   3                              case SHUTDOWN: 
 351   3                                      KT_WirelessMicTx_PASW(PA_OFF);
 352   3                                      LcdClean();
 353   3                                      LcdClose();
 354   3                                      if(LINE_EN)//如果此时插入充电线，那就进入充电状态，否则，INIT
 355   3                                      {
 356   4       
 357   4                                              SysState(BAT_CHARGE);
 358   4                                              CHIP_EN_OUT;
 359   4                                              CHIP_EN = Disable; 
 360   4                                      }
 361   3                                      else
 362   3                                              SysState(S_INIT); 
 363   3                              break;
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 7   

 364   3                              case UHF_SET:
 365   3                                      FreqTune(SetFreq());
 366   3                                      SysState(RAIL_DIS);
 367   3                              break;
 368   3                              case UHF_CH:  
 369   3                                      LedLightApi();
 370   3                                      BPSKMode(order4); 
 371   3                                      SysState(RAIL_DIS);     
 372   3                              break;
 373   3                              case SET_OK:  
 374   3                                      MuteLconDis();          
 375   3                                      LockLconDis();
 376   3                                      ChannelDis(); 
 377   3                                      SysState(READY); 
 378   3                              break;
 379   3                              case SET_ID:   
 380   3                                      LedLightApi();
 381   3                                      BPSKMode(order4); 
 382   3                                      SysState(RAIL_DIS);
 383   3                              break;
 384   3                              case RAIL_DIS:
 385   3      
 386   3                              break;
 387   3                              case SET_VOL: 
 388   3                                      FlashWrite(FLASH_ID_VOLUME,u_dat.vol);
 389   3                                      ShowIco(LCD_ICON_DB,RESET);
 390   3                                      SysState(READY);
 391   3                              break;
 392   3                              case SET_AUTOMUTE:
 393   3                                      SysState(RAIL_DIS);
 394   3                              break;
 395   3                              case SET_ID_PRESS: 
 396   3                                       
 397   3                              break;
 398   3                              case SET_EQ:
 399   3                                      FlashWrite(FLASH_ID_EQ,u_dat.eq);
 400   3                                      SysState(READY);
 401   3                              break;
 402   3                              case BAT_CHARGE:
 403   3                                       
 404   3                              break;
 405   3                              case CHECK_DIS:
 406   3                                      ShowIco(LCD_ICON_DB,RESET);
 407   3                                      SysState(READY);
 408   3                              break;
 409   3                      }
 410   2              } 
 411   1      }
 412          
 413           
 414           
 415           /*****************************************
 416                    check enter stop mode 
 417          ******************************************/
 418          void EnterStopMode(void)
 419          { 
 420   1                      IO_DeInit();  //不动5_0口
 421   1                      Delay_ms(100);
 422   1       
 423   1       
 424   1       
 425   1              /*******************  key       **********************/
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 8   

 426   1      //              GPIO_SET(xP5MDL,GPIO_UI,0);// 
 427   1                      GPIO_SET(P1MDL,GPIO_UI,1);// 
 428   1                      GPIO_SET(P1MDL,GPIO_UI,2);// 
 429   1                      GPIO_SET(P1MDL,GPIO_UI,3);// 
 430   1              /*****************************************/
 431   1                      
 432   1              /*******************  adc_bat   **********************/ 
 433   1                      AD_DeInit();
 434   1                      GPIO_SET(P3MDL,GPIO_OI,0);
 435   1              /*****************************************/
 436   1              
 437   1               
 438   1              
 439   1              /*************          LED     ***************/
 440   1                      LcdClose();
 441   1              /*******************************/
 442   1                      
 443   1      /*************  0646    ***************/
 444   1              GPIO_SET(P2MDL,GPIO_PP,2);//chip_en
 445   1              CHIP_EN = Enable;  
 446   1              CHIP_EN = Disable;  
 447   1              /*******************************/
 448   1              
 449   1      //      /*************  other   ***************/
 450   1       
 451   1              GPIO_SET(P2MDL,GPIO_PP,1);//POWER
 452   1              POWER = 0; 
 453   1                      /*power
 454   1                        line_en
 455   1                      */
 456   1              GPIO_SET(P0MDL,GPIO_OI,1);//充电判断引脚 为中断1做好准备
 457   1              /*******************************/       
 458   1        
 459   1                      stop_mode(); 
 460   1      }
 461          
 462          void StopDelay(void)
 463          {
 464   1              
 465   1              if(Sdata.stop_time > 0 && Sdata.state == S_INIT) 
 466   1              {
 467   2      //              ShowNumber(Sdata.stop_time);
 468   2                      Sdata.stop_time--;
 469   2                      
 470   2                      if(Sdata.stop_time == 0)
 471   2                      {
 472   3                              EnterStopMode();
 473   3                      }
 474   2              }
 475   1       
 476   1      }
 477          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1150    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      9    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.53.0.0   SYSTEM                                                            06/09/2020 11:57:22 PAGE 9   

   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
